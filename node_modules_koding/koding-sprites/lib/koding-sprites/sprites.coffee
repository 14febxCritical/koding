"use strict"

{ promisify, promisifyAll } = require 'bluebird'
generateSprites = promisify require 'node-sprite-generator'
fs = promisifyAll require 'fs'
{ join: joinPath } = require 'path'

createStylusHelper = require './stylus-helper.coffee'
stylusHandler = require './stylus-handler.coffee'

module.exports = (options, callback) ->
  options.retinaRe ?= /@2x$/

  dir = joinPath process.cwd(), options.path

  fs.readdirAsync dir
    .bind {}
    .map (item) -> joinPath dir, item
    .filter (spritePath) ->
      (fs.statAsync spritePath).then (stats) -> stats.isDirectory()
    .map (spritePath) ->
      isRetina = options.retinaRe.test spritePath
      generateSprites
        src         : ["#{ spritePath }/*.png"]
        spritePath  : "#{ spritePath }.sprite.png"
        stylesheet  : stylusHandler.bind this, isRetina
    .then -> createStylusHelper this, options
    .nodeify callback
