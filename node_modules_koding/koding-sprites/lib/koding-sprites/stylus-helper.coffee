require 'colors'

{ join: joinPath } = require 'path'
{ nodes } = require 'stylus'

assertSprite = (name, sprite) ->
  throw new Error "missing sprite #{ name }"  unless sprite?

module.exports = (layouts, options) ->
  {
    image: ({ string: name }, { string: image }, dimensions) ->
      dimensions = if dimensions then dimensions.val else yes
      sprite = layouts[name][image]
      assertSprite name, sprite

      { width, height, top, left } =
        if options.retinaRe.test name
        then sprite.retina()
        else sprite

      if dimensions
        widthNode = new nodes.Property ['width'], "#{ width }px"
        heightNode = new nodes.Property ['height'], "#{ height }px"
        @closestBlock.nodes.splice @closestBlock.index+1, 0, widthNode, heightNode

      backgroundUrl = joinPath options.httpPath ? options.path, sprite.filename()

      background = "url(#{ backgroundUrl }) #{ left }px -#{ top }px"

      new nodes.Property ['background'], background

    dimensions: ({ string: name }, { string: image }) ->
      sprite = layouts[name][image]
      assertSprite name, sprite

      { sprite: { width, height } } =
        if options.retinaRe.test name
        then sprite.retina()
        else sprite

      return new nodes.Unit "#{width}px #{height}px"
  }