request = require 'request'
{EventEmitter}  = require 'events'

module.exports = class ServiceManager extends EventEmitter

  resellerMainURL = "https://test.httpapi.com/api"

  constructor:(authUserId, apiKey)->
    @authUserId  = "464180"
    @apiKey      = "apCPJwh8CIYzsPVdQsVVLD3WLj3kR5jK"

  makeRequestToResellerApi:(options, callback)->
    paramsToAdd = ""

    for key,value of options.parameters
      if Array.isArray value
        for i,paramValue of value
          paramsToAdd += "&#{key}=#{paramValue}"
      else
        paramsToAdd += "&#{key}=#{value}"

    reqUri = "#{resellerMainURL}/"              +
             "#{options.service}/"              + 
             "#{options.action}."               + 
             "json?auth-userid=#{@authUserId}&" + 
             "api-key=#{@apiKey}"               +
             "#{paramsToAdd}"

    requestOptions =
      method  : 'GET'
      uri     : reqUri

    request requestOptions, (err, res, body)=>
      @_handleResponse callback, err, res, body

  _handleResponse:(callback, error, response, body)->
    if error 
      console.log "ERROR", error
      return callback error

    responseBody = JSON.parse body
    if responseBody.status in ["error", "ERROR"]
      callback responseBody.message or responseBody.error

    callback null, responseBody