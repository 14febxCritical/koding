request = require 'request'
{EventEmitter}  = require 'events'

module.exports = class ServiceManager extends EventEmitter

  resellerMainURL = "https://test.httpapi.com/api"

  constructor:(authUserId, apiKey)->
    @authUserId  = "464180"
    @apiKey      = "apCPJwh8CIYzsPVdQsVVLD3WLj3kR5jK"

  makeRequestToResellerApi:(options, callback)->
    paramsToAdd = ""

    for key,value of options.parameters
      if Array.isArray value
        for i,paramValue of value
          paramsToAdd += "&#{key}=#{paramValue}"
      else
        paramsToAdd += "&#{key}=#{value}"

    reqUri = "#{resellerMainURL}/"              +
             "#{options.service}/"              + 
             "#{options.action}."               + 
             "json?auth-userid=#{@authUserId}&" + 
             "api-key=#{@apiKey}"               +
             "#{paramsToAdd}"

    requestOptions =
      method  : 'GET'
      uri     : reqUri


    request.post requestOptions, (error, response, body) =>
      if error
        console.log "ERROR", error
        res.send 401, JSON.stringify {error: "unauthorized - error code 2"}
      else if response.statusCode is 200
        callback JSON.parse body

