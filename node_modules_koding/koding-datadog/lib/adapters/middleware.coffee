{ argv }  = require 'optimist'
KONFIG    = require('koding-config-manager').load("main.#{argv.c}")
Timer     = require '../timer'
DogStatsD = require '../dogstatsd'
onHeaders = require 'on-headers'


module.exports = middleware = {

  prefix : 'nodejs.webserver'


  sanitize : (string) ->

    return string
      .replace /\/$/g,      'home'  # replace last / with home
      .replace /[\/-]/g,    '.'     # replace all / with .
      .replace /\.{2,}/g,   '.'     # remove adjacent dots

  getMetricName : (path) -> @sanitize "#{@prefix}.#{path}"


  populateTags : (req, res, tags) ->

    tags ?= []

    tags.push "version:#{KONFIG.version}"
    tags.push "http_method:#{req.method}"
    tags.push "http_response_code:#{res.statusCode}"

    return tags


  sendMetrics : (req, res, next) ->

    Timer.start()
    metricName      = middleware.getMetricName(req.path)
    elapsedTime     = 0
    dogStatsDClient = DogStatsD.getClient()

    onHeaders res, ->
      tags        = middleware.populateTags req, res
      elapsedTime = Timer.getElapsedTimeInMilliSecs()
      dogStatsDClient.histogram "#{metricName}.response_time", elapsedTime, tags

    # storing res.end
    end = res.end

    res.end = ->
      tags = middleware.populateTags req, res
      dogStatsDClient.increment "#{metricName}.page_view", 1, tags

      # calling end function in res context
      end.apply(res, arguments)

    next()

}
