falafel = require 'falafel'
{argv} = require 'optimist'

compile =require './compile'

compileAll =(source)->
  falafel source, (node)->
    if node.type is 'Literal'
      node.update compile node.source()

module.exports = (src, magicWord="pistachio")->
  falafel src, (node)->

    isMagicProperty = node.type is 'Property' and node.key.name is magicWord
    
    isAssignmentExpression = node.type is 'AssignmentExpression'
    
    isMagicMember = isAssignmentExpression and\
                    node.left.type is 'MemberExpression' and\
                    node.left.property.name is magicWord
    
    isMagicIdentifier = isAssignmentExpression and\
                        node.left.type is 'Identifier' and\
                        node.left.name is magicWord

    if isMagicProperty or isMagicMember or isMagicIdentifier
      node.update compileAll node.source()