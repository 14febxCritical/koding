
module.exports = class KodingCounter

  {extend} = require 'underscore'

  constructor: (options) ->
    return new KodingCounter options  unless this instanceof KodingCounter
    {@counterName, @db, collectionName, offset} = options
    @collectionName = collectionName ? 'counters'
    @offset         = offset ? 0

  wrap = (callback) -> (err, doc)-> callback err, (doc?.seq - 1) or 0

  getCollection: -> @db.collection @collectionName

  update:->
    switch arguments.length
      when 1
        [update] = arguments
      when 2
        [update, callback] = arguments
      when 3
        [query, update, callback] = arguments

    callback  ?= ->
    options   = { new: yes, upsert: yes }
    query     ?= {}
    query     = extend { _id: @counterName }, query
    sort      = [['_id', 'desc']]

    @getCollection().findAndModify query, sort, update, options, callback

  next: (callback) -> @update { $inc: seq: 1 }, wrap callback

  count: (callback) ->
    @getCollection().findOne { _id: @counterName }, { seq:1 }, (err, counter)->
      return callback err  if err
      callback null, counter?.seq ? 0

  reinitialize: (callback)->
    @initialize yes, callback

  initialize: (reinitialize, callback) ->
    [reinitialize, callback] = [callback, reinitialize]  unless callback
    unless callback then callback = ->
    return @update { $set: seq: @offset }  if reinitialize
    selector = { seq: $gt: @offset }

    @getCollection().count selector, (err, count)=>
      return callback err  if err
      if count is 0
      then @update selector, { $set: seq: @offset }, wrap callback
      else callback null