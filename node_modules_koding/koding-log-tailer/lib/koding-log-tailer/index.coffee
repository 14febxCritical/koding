amqp = require 'amqp'

fetchConnection =(connection, callback)->
  if connection instanceof amqp.Connection
    if connection.readyState > 0
      return callback connection
  else
    connection = amqp.createConnection conn
  connection.on 'ready', -> callback connection

module.exports = (options, stream)->
  fetchConnection options.connection, (connection)->
    topic = options.topic ? options.hostname?.split('.').reverse().join('.')+'.#' ? '#'    
    connection.exchange 'logs',
      durable     : no
      autoDelete  : yes
    , (exchange)->
      connection.queue '', (queue)->
        queue.bind exchange, topic
        queue.on 'queueBindOk', ->
          queue.subscribe (message)->
            stream.write message.data