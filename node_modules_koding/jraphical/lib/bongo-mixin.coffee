Bongo = require 'bongo'

module.exports =-> bongoMixin.call Bongo.prototype

### where bongo mixin looks like: ###

bongoMixin = ->
  Bongo.prototype.on 'newInstance', (instance)->
    {Relationship} = require 'jraphical'
    Relationship.addBongo instance
  oldHandleEvent = @handleEvent
  @handleEvent = (rest...)->
    eventType = rest[0]
    eventName = rest[2]
    if eventName?
      switch eventName
        when "updateInstance"
          if eventType == "static"
            data =  { event : eventName, payload : [rest[3]]}
            @mq.emit 'neo4jFeederExchange', "", JSON.stringify(data), autoDelete: no

          if eventType == "instance"
            data =  { event : eventName, payload : [rest[1]]}
            @mq.emit 'neo4jFeederExchange', "", JSON.stringify(data), autoDelete: no

        when "RelationshipSaved", "RelationshipRemoved", "RemovedFromCollection"
          data =  { event : eventName, payload : rest[3]}
          @mq.emit 'neo4jFeederExchange', "", JSON.stringify(data), autoDelete: no

    oldHandleEvent.apply this, rest
