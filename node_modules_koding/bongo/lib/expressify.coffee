module.exports = ->
  { dash } = require 'bongo'

  bongo = this

  (req, res, next) ->

    {
      channelName
      queue: requestQueue
      sessionToken
      userArea
    } = req.body

    unless requestQueue?.length
      return res.status(400).end()

    responseQueue = new Array requestQueue.length

    bongo.fetchClient sessionToken, userArea, (client) ->

      unless client
        console.log "bongo.fetchClient: #{sessionToken} not found in #{userArea}"
        return res.status(500).send 'An error occcurred'

      workQueue = requestQueue.map (message, i) -> ->
        bongo.handleRequest channelName, { message, client }, (secretName, callbackId, args) ->
          bongo.scrubResponse callbackId, args, (message) ->
            responseQueue[i] = message
            workQueue.fin()

      dash workQueue, -> res.send responseQueue
