module.exports = ->
  { dash } = require 'bongo'

  bongo = this

  (req, res, next) ->

    { channelName, queue: requestQueue } = req.body

    unless requestQueue?.length
      return res.status(400).end()

    responseQueue = new Array requestQueue.length

    workQueue = requestQueue.map (message, i) -> ->
      bongo.handleRequest channelName, { message }, (secretName, callbackId, args) ->
        bongo.scrubResponse callbackId, args, (message) ->
          responseQueue[i] = message
          workQueue.fin()

    dash workQueue, -> res.send responseQueue
