fs            = require 'fs'
csv           = require 'csv'
async         = require 'async'
nodePath      = require 'path'
{Stream}      = require 'stream'
{MongoClient} = require 'mongodb'


fetchDb = (mongo, callback) ->
  throw new Error 'need a mongo connection'  unless mongo

  if 'string' is typeof mongo
    MongoClient.connect 'mongodb://localhost/test', callback
  else
    process.nextTick -> callback null, mongo


module.exports = (options) ->
  { path, mongo, collectionName, encoding, dropFirst, delimiter } = options

  path      ?= nodePath.join __dirname, '../db/allCountries.txt'#'../db/zips.csv'
  delimiter ?= '\t'
  encoding  ?= 'utf-8'
  dropFirst ?= yes

  stream = new Stream

  stream.end = -> stream.emit 'end'

  fetchDb mongo, (err, db) ->
    return stream.emit 'error', err  if err

    collection = db.collection collectionName

    queue = []

    if dropFirst
      queue.push (next) -> collection.drop -> next()

    queue.push (next) ->
      csv()
        .from.path(path, { delimiter, encoding })
        .to.stream(stream)
        .on( 'record', (row, i) ->

          [
            countryCode
            zip
            city
            state
            stateCode
            county
          ] = row

          doc = {
            zip
            city
            county
            state
            stateCode
            countryCode
          }

          collection.insert doc, (err) ->
            return stream.emit 'error', err  if err
        )
        .on 'close', -> next()

    async.series queue, ->
      collection.createIndex 'zip'

  return stream
