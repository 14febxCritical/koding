# Rabbit structure - Workers

## alerter

Not used

## auth worker
Auth worker files are under:

`/worker/auth/lib/auth/`

Following option is used for declaring Exchange (both for publish and consume):

```
AUTH_EXCHANGE_OPTIONS =
  type        : 'fanout'
  autoDelete  : yes
```

Rabbitmq related stuff is in:

`worker/auth/lib/auth/authworker.coffee`

### **Auth Worker is consuming:**

  via `connect:->`
  * 'fanout' type, exchange name: 'auth'
  *  get `messageData` and `routingKey`. Handles acording to the incoming routingKey

```
switch routingKey
  when 'broker.clientConnected' then # ignore
  when 'broker.clientDisconnected'
    @cleanUpAfterDisconnect messageStr
  when 'kite.join'
    @addService messageData
  when 'kite.leave'
    @removeService messageData
  when 'client.auth'
    @joinClient messageData, socketId
  else
    @rejectClient routingKey
```

### **Auth Worker is publishing:**

 via `joinClient =(messageData, socketId)->`
  * 'fanout' type, exchange name: content of incoming `messageData`
  * publishing message with bindingKey(routingKey): 'auth.join' and data: {username: session.username,  routingKey  : routingKey }, session comes from JSession and routingKey comes from incoming message
  * 'auth.join' is used by
     * `go/src/koding/tools/kite/kite.go`
     * `node_modules_koding/bongo/lib/bongo.coffe`
     * `node_modules_koding/kite-aqmp/lib/kite-amqp/index.coffee`

 via `cleanUpClient:(client)->`
  * 'fanout' type exchange named according to incoming 'messageData'
  * publishing message with bindingKey(routingKey): 'auth.leave' and data: {routingKey: client.routingKey }, client.routingKey comes from the callback 'client' that comes via cleanUpclient.
  * 'auth.leave' is used by
     * `go/src/koding/tools/kite/kite.go`
     * `node_modules_koding/bongo/lib/bongo.coffe`
     * `node_modules_koding/kite-aqmp/lib/kite-amqp/index.coffee`

## cacher

Cacher worker files are under:

`/worker/cacher`

Rabbitmq related stuff is in:

`worker/cacher/index.coffe`

### **Cacher Worker is consuming:**

  via `koding.connect:->`
  * 'topic' type, exchange name: 'broker', autoDelete:no
  *  routingKey for binding is 'constructor.CActivity.event.#'
    * queue.bind exchange, 'constructor.CActivity.event.#'
  *  get `messageData` and `deliveryInfo.routingKey`
  * emits according to incoming eventName = deliveryInfo.routingKey.split('.').pop()

## emailnotifications

Do not uses rabbit

## guestcleanup

Do not uses rabbit

## kitemonitor

Do not uses rabbit

## librato

Do not uses rabbit

## social
Do not uses rabbit


# Rabbit structure - Kites

1. Kites extending from kite-amqp. kite-amqp is under:

`/node_modules_koding/kite-aqmp/lib/kite-amqp/index.coffee`

Rabbitmq related stuff is in:

`/node_modules_koding/kite-aqmp/lib/kite-amqp/index.coffee`

### **Kite-amqp is consuming:**

  via `registerSelf:->`

* 'fanout' type, exchange name: "kite-kiteName-pidNumber", these are added in this way:

```
getKiteId:-> "#{process.pid}|#{require('os').hostname().replace /\./g, '_'}"
getServiceType:-> "kite-#{@kiteName}"
getRabbitMqResourceName:-> "#{@getServiceType()}-#{@getKiteId()}"
exchangeName = @getRabbitMqResourceName()
```

  *  get `messageData` and `routingKey`. Handles according to the incoming routingKey (@handleMessage function)

```
switch routingKey
  when 'auth.join'  then @join messageData
  when 'auth.leave' then @leave messageData
```

### **Kite-ampq is publishing:**

 `handleResponse:(routingKey, callbackId, args)->` (@handleMessage)
  * '' type, exchange name: 'broker'
  * publishing message with bindingKey(routingKey): 'auth.join' and data get via `scrubber = new Scrubber @localstore`
  * 'auth.join' is used by
     * `go/src/koding/tools/kite/kite.go`
     * `node_modules_koding/bongo/lib/bongo.coffe`
     * `worker/auth/lib/auth/authworker.coffee`


