# kite worker example
{kite} = require 'koding-kite'

main = ()->
  options = new kite.Options
              kitename:    "mathworker"
              version:     "0.0.1"
              port:        "9999"
              region:      "localhost"
              environment: "development"
              publicIP:    "127.0.0.1"
              username:    "devrim"

  mathWorker = kite.New options
  # lets attach our handlers...
  mathWorker.handleFunc "square", square
  mathWorker.handleFunc "squareSync", squareSync
  mathWorker.handleFunc "doubleSquare", doubleSquare
  mathWorker.handleFunc "squareWithError", squareWithError
  mathWorker.start ->

# you can write handlers in async/nodejs way
square = (request, callback)->
  request.remoteKite.go "log", "received args #{request.args}"
  callback null, request.args * request.args

# or you can also do it in sync fashion
# as in Go kites.
squareSync = (request)->
  return request.args * request.args

# more sync style, you can use fibers, so you can
# wait a callback from db etc. and continue and return result in future
doubleSquare = (request)->
  double = 0
  fiber = kite.Fiber.current
  setTimeout ()->
    console.log "1 second later"
    double = 2  # we set double 1 second later, after db callback perhaps
    fiber.run() # then continue execution
  , 1000
  kite.Fiber.yield() # stop here
  return request.args * request.args * double # then return our result

# want to return an error, just throw it as usual
squareWithError = (request)->
  if request.args is 12
    throw new kite.KiteError "We dont like 12" # throwing error will not kill your process
  return request.args * request.args

main()
