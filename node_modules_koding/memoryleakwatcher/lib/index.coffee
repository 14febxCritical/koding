memwatch   = require 'memwatch'
v8profiler = require 'v8-profiler'

latestHeapSnapshot = null

watch = ->

  setInterval ->
    latestHeapSnapshot = v8profiler.takeSnapshot()
  , 1000

  #TODO upload snapshots to s3
  memwatch.on 'leak', (info) ->
    leakedHeapSnapshot = v8profiler.takeSnapshot()
    console.log 'Memory leakage detected ', info
    console.log 'Snapshot headers: Leaked snapshot:', leakedHeapSnapshot.getHeader(), 'Latest snapshot before the leak:', latestHeapSnapshot.getHeader()
    console.log 'Leaked snapshot compared to the latest snapshot: ', latestHeapSnapshot.compare leakedHeapSnapshot

module.exports = {
  watch
}