AWS        = require 'aws-sdk'
memwatch   = require 'memwatch'
v8profiler = require 'v8-profiler'

snapshotInterval   = null
latestHeapSnapshot = {}

state      = off
bucket     = 'koding-nodejs-runtime-heapsnapshots'
AWS_KEY    = null
AWS_SECRET = null

handleSnapshots = (info) ->

  leakedHeapSnapshot = { content: v8profiler.takeSnapshot(), date: Date.now() }
  console.log 'Memory leakage detected ', info
  console.log 'Snapshot headers: Leaked snapshot:', leakedHeapSnapshot.content.getHeader(), 'Latest snapshot before the leak:', latestHeapSnapshot.content.getHeader()
  console.log 'Leaked snapshot compared to the latest snapshot: ', latestHeapSnapshot.content.compare leakedHeapSnapshot.content

  leakedHeapSnapshot.key = "leakedHeapSnapshot.#{leakedHeapSnapshot.date}.heapsnapshot"
  latestHeapSnapshot.key = "latestHeapSnapshot.#{latestHeapSnapshot.date}.heapsnapshot"

  s3Upload [leakedHeapSnapshot, latestHeapSnapshot]


s3Upload = (snapshots) ->

  s3Bucket = new AWS.S3 { params: { Bucket: bucket } }
  s3Bucket.createBucket ->

    snapshots.forEach (snapshot) ->
      { key, content } = snapshot

      content.export (err, result) ->
        return console.log err  if err
        params = { Key: key, Body: result }

        s3Bucket.upload params, (err) ->
          return console.log err  if err
          console.log "#{key} uploaded to s3 bucket #{bucket}"

start = ->

  state = on

  # take an initial snapshot
  latestHeapSnapshot = { content: v8profiler.takeSnapshot(), date: Date.now() }

  # then take a heap snapshot every second
  snapshotInterval = setInterval ->
    latestHeapSnapshot = { content: v8profiler.takeSnapshot(), date: Date.now() }
  , 1000

  memwatch.on 'leak', handleSnapshots
  console.log "Started watching possible memory leakage for the process with id #{process.pid}"


stop = ->

  state = off

  if snapshotInterval
    clearInterval snapshotInterval

  memwatch.removeListener 'leak', handleSnapshots
  console.log "Stopped watching possible memory leakage for the process with id #{process.pid}"


setup = (options = {}) ->
  console.log "To start/stop watching memory profiling send SIGUSR2 to PID #{process.pid}"

  { AWS_KEY, AWS_SECRET } = options
  AWS.config.update { accessKeyId: AWS_KEY, secretAccessKey: AWS_SECRET }

  process.on 'SIGUSR2', ->
    if state is off
    then start()
    else stop()


module.exports = {
  setup
}
