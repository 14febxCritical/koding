#!/usr/bin/env coffee

argv       = require('minimist')(process.argv.slice(2))
log        = console.log
fs         = require 'fs'


# ./run assumes development - comes bundled with these options.
options = o =
  projectRoot      : argv.projectRoot    or __dirname
  config           : argv.config         or "dev"
  region           : argv.region         or "dev"
  branch           : argv.branch         or "cake-rewrite"
  build            : argv.build          or 1
  version          : argv.version        or "1.0"
  environment      : argv.environment    or "dev"
  hostname         : argv.hostname       or "lvh.me:8090"
  publicHostname   : argv.publichostname or process.env.USER
  target           : argv.target         or "localhost"
  onlyconfigure    : argv.onlyconfigure  or no
  supervisor       : argv.supervisor     or no
  deploy           : argv.deploy         or no


console.log "Configuring with options:",o


KONFIG = require("./config/main.#{o.config}.coffee")(options)


createRunFile = (KONFIG)->

  fs.writeFileSync "run",KONFIG.runFile
  fs.chmodSync "./run", 0o755

  # write supervisor config
  if o.supervisor
    fs.writeFileSync "/etc/supervisor/conf.d/koding.conf",KONFIG.supervisorConf

  log "Configuration done"
  log "1) install Docker and ngrok (ngrok is optional)"
  log "2) do './run services' for backend services after installing docker."
  log "3) do './run install' "
  log "4) you can then type './run' to run Koding and see it on http://lvh.me:8090"


createRunFile KONFIG












