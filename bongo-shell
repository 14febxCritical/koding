#!/usr/bin/env coffee
nesh = require('nesh')
argv = require('optimist').argv
# -c config file
# -f eval coffeescript file
fs = require 'fs'

Bongo    = require 'bongo'
Broker   = require 'broker'
{argv}   = require 'optimist'
{extend} = require 'underscore'

if argv.c
  KONFIG = require('koding-config-manager').load("main.#{argv.c}")  
else
  KONFIG = require('koding-config-manager').load("main.vagrant")

{mongo, mq, projectRoot, webserver} = KONFIG

mqOptions = extend {}, mq
mqOptions.login = webserver.login  if webserver?.login?
mqOptions.productName = 'koding-webserver'


opts =
  welcome: 'Welcome to koding...'
  prompt: 'bongo> '

nesh.config.load()
nesh.loadLanguage('coffee')


bongoPlugin =
    name: "bongoplugin"
    description: "Some description here"
    setup: (context, next) ->
      {defaults} = context
      next()

    preStart: (context, next) ->
      {options} = context
      next()

    postStart: (context, next)->
      {repl} = context
      repl.context.md5 = (value) ->
        crypto.createHash('md5').update(value).digest 'hex'

      repl.context.bongo = bongo
      for i of bongo.models
        repl.context[i] = bongo.models[i]
      console.log "Press enter to start"
      next()

startShell = ()->
  nesh.loadPlugin bongoPlugin, (err) ->
    nesh.log.error err if err
    if argv.f
      opts.evalData = nesh.compile fs.readFileSync argv.f, 'utf-8'
    nesh.start opts, (err)->
      if (err)
        nesh.log.error(err)

class BongoWithOnReady extends Bongo

  constructor: (options)->
    @on 'newModel', (m)->
      console.log "loaded model", m

    @on 'ready', ()->
      console.log "Bongo is ready"

    @on 'newInstance', ()->
      # TODO: couldnt find a better solution then 
      # adding timeout. Checked events but this is
      # the only solution to make it work in node v.0.8
      setTimeout ()->
        startShell()
      , 1000
    super(options)

bongo = new BongoWithOnReady {
  mongo
  root: projectRoot
  models: 'workers/social/lib/social/models'
  mq: new Broker mqOptions
  resourceName: webserver.queueName
}


