#!/usr/bin/env coffee
nesh = require('nesh')
argv = require('optimist').argv
# -c config file
# -f eval coffeescript file
fs = require 'fs'

{Base, Model} = require 'bongo'
if argv.c
  KONFIG = require('koding-config-manager').load("main.#{argv.c}")  
else
  KONFIG = require('koding-config-manager').load("main.vagrant")
Model.setClient KONFIG.mongo
JStatusUpdate = require './workers/social/lib/social/models/messages/statusupdate/index.coffee'

opts =
  welcome: 'Welcome!'
  prompt: 'bongo> '

nesh.config.load()
nesh.loadLanguage('coffee')

bongoPlugin =
    name: "bongoplugin"
    description: "Some description here"
    setup: (context, next) ->
        {defaults} = context
        next()

    preStart: (context, next) ->
      {options} = context
      next()

    postStart: (context, next)->
      {repl} = context
      repl.context.md5 = (value) ->
        crypto.createHash('md5').update(value).digest 'hex'
      repl.context.Base = Base
      for i of Base.constructors
        repl.context[i] = Base.constructors[i]
      next()

nesh.loadPlugin bongoPlugin, (err) ->
  nesh.log.error err if err
  if argv.f
    opts.evalData = nesh.compile fs.readFileSync argv.f, 'utf-8'
  nesh.start opts, (err)->
      if (err)
          nesh.log.error(err)

