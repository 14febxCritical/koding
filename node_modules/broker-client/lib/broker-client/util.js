
module.exports = (function() {
  var performTask, sendWsMessage;
  sendWsMessage = function(ws, event, exchange, options) {
    var subJSON;
    if (options == null) {
      options = {};
    }
    if (ws.readyState > 0) {
      subJSON = {
        event: event,
        exchange: exchange
      };
      if (options.payload != null) {
        subJSON.payload = options.payload;
      }
      if (options.routingKey != null) {
        subJSON.routingKey = options.routingKey;
      }
      if (options.meta != null) {
        subJSON.meta = options.meta;
      }
      return ws.send(JSON.stringify(subJSON));
    } else {
      return ws.addEventListener("open", sendWsMessage.bind(this, ws, routingKey, channel, payload, options));
    }
  };
  performTask = function(channel, readyCallback) {
    var channelName;
    if (channel.ws.readyState > 0) {
      if (!channel.isPrivate || channel.privateName) {
        channelName = channel.privateName || channel.name;
        return readyCallback(channelName);
      } else {
        return channel.emitter.on("authorized", performTask.bind(this, channel, readyCallback));
      }
    } else {
      return channel.ws.addEventListener("open", performTask.bind(this, channel, readyCallback));
    }
  };
  return {
    sendWsMessage: sendWsMessage,
    performTask: performTask
  };
})();
