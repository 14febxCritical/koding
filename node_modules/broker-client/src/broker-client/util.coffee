'use strict'

module.exports = do ->
  sendWsMessage = (ws, event, exchange, options={}) ->
    if ws.readyState > 0
      subJSON = {event, exchange}
      subJSON.payload = options.payload  if options.payload?
      subJSON.routingKey = options.routingKey  if options.routingKey?
      subJSON.meta = options.meta  if options.meta?
      ws.send JSON.stringify(subJSON)
    else
      ws.addEventListener "open", sendWsMessage.bind(this, ws, routingKey, channel, payload, options)

  performTask = (channel, readyCallback) ->
    if channel.ws.readyState > 0
      if not channel.isPrivate or channel.privateName
        channelName = channel.privateName or channel.name
        readyCallback channelName
      else
        channel.emitter.on "authorized", performTask.bind(this, channel, readyCallback)
    else
      channel.ws.addEventListener "open", performTask.bind(this, channel, readyCallback)

  {sendWsMessage, performTask}