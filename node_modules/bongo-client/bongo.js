/*
Bongo.js
Unfancy models for MongoDB

(c) 2011 Koding, Inc.

@module: bongo-client
@author: Christopher Thorn <chris@koding.com>
*/
/*
@snippet.
@description: feature-detect the browser.
@todo: is there an improvement?
@foo
*/
var Bongo, isBrowser;
var __slice = Array.prototype.slice, __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };
isBrowser = 'undefined' != typeof window;
/*
@class: bongo (client)
@description: client-side bongo.
*/
Bongo = (function() {
  var EventEmitter, JsPath, Model, ModelLoader, Scrubber, Store, Traverse, createBongoName, createId, createRemoteApiShims, dash, dnode, extend, race, sequence, slice, _ref, _ref2, _ref3;
  EventEmitter = require('events').EventEmitter;
  Traverse = require('traverse');
  createId = Bongo.createId = require('hat');
  dnode = require('koding-dnode');
  Bongo.dnodeProtocol = require('koding-dnode-protocol');
  _ref = Bongo.dnodeProtocol, Store = _ref.Store, Scrubber = _ref.Scrubber;
  Bongo.EventEmitter = EventEmitter;
  Model = Bongo.Model = require('./src/model');
  ModelLoader = require('./src/modelloader');
  JsPath = Bongo.JsPath = require('./src/jspath');
  slice = [].slice;
  extend = require('./src/util').extend;
  _ref2 = require('sinkrow'), race = _ref2.race, sequence = _ref2.sequence, dash = _ref2.dash;
  _ref3 = require('sinkrow'), Bongo.daisy = _ref3.daisy, Bongo.dash = _ref3.dash, Bongo.sequence = _ref3.sequence, Bongo.race = _ref3.race, Bongo.future = _ref3.future;
  createBongoName = function() {
    return 'bongo.' + createId();
  };
  createRemoteApiShims = function(api) {
    var methods, name, _ref4, _ref5, _results;
    _results = [];
    for (name in api) {
      methods = api[name];
      console.log('constructor', name);
      if ((_ref4 = methods.statik) != null ? _ref4.length : void 0) {
        console.log('static methods', methods.statik);
      }
      _results.push(((_ref5 = methods.instance) != null ? _ref5.length : void 0) ? console.log('instance methods', methods.instance) : void 0);
    }
    return _results;
  };
  function Bongo(options) {
    this.mq = options.mq;
    this.bongoName = createBongoName();
    this.channelName = 'private-' + this.bongoName;
    this.localStore = new Store;
    this.remoteStore = new Store;
  }
  Bongo.prototype.handleRequest = function(message) {
    var callback, method, scrubber, unscrubbed;
    if (message === 'ready') {
      return this.fetchApi();
    } else {
      method = message.method;
      scrubber = new Scrubber(this.localStore);
      unscrubbed = scrubber.unscrub(message, __bind(function(callbackId) {
        if (!this.remoteStore.has(secretName + callbackId)) {
          this.remoteStore.add(secretName + callbackId, __bind(function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return this.handleResponse(secretName, callbackId, args);
          }, this));
        }
        return this.remoteStore.get(secretName + callbackId);
      }, this));
      if (method === 'fetchApi') {
        return this.fetchApi.apply(this, unscrubbed);
      } else if (!isNaN(+method)) {
        callback = this.localStore.get(method);
        console.log('kallback', callback);
        return callback != null ? callback.apply(null, unscrubbed) : void 0;
      } else {
        return console.log(method);
      }
    }
  };
  Bongo.prototype.connect = function(callback) {
    this.channel = this.mq.subscribe(this.channelName);
    return this.channel.once('broker:subscription_succeeded', __bind(function() {
      this.channel.on('server-message', this.handleRequest.bind(this));
      return callback(null);
    }, this));
  };
  Bongo.prototype.send = function(method, args) {
    var scrubber;
    if (!Array.isArray(args)) {
      args = [args];
    }
    if (!this.channel) {
      throw new Error('No channel!');
    } else {
      scrubber = new Scrubber(this.localStore);
      return scrubber.scrub(args, __bind(function() {
        var message;
        message = scrubber.toDnodeProtocol();
        message.method = method;
        return this.channel.emit('client-message', JSON.stringify(message));
      }, this));
    }
  };
  Bongo.prototype.disconnect = function(callback) {};
  Bongo.prototype.fetchApi = function(callback) {
    return this.send('fetchApi', __bind(function(err, api) {
      console.log('hello', api);
      return this.api = createRemoteApiShims(api);
    }, this));
  };
  Bongo.prototype.dispatchMethod = function(constructorName, method, context, args) {};
  Bongo.prototype.use = function() {};
  return Bongo;
})();
if (!isBrowser && module) {
  module.exports = Bongo;
} else {
  if (typeof window !== "undefined" && window !== null) {
    window['Bongo'] = Bongo;
  }
}