module.exports = do->  
  getPusherEvent =(event)->
    if Array.isArray(event)
      event = event.join ':'
    else event

  afterInit:do ->
    channels = {}
    ->
      {broadcastable} = @constructor
      id = @getId?() or @bongo_?.instanceId
      if broadcastable and id?
        name = "object-#{id}"
        @channel = channels[name] or= @mq.subscribe name
        @channel.on 'updateInstance', (data)=> @update_(data)
  
  destroy:->
    return unless @channel?
    @mq.unsubscribe @channel
  
  on:(event, listener)->
    {constructor} = @
    event = getPusherEvent(event)    
    @channel.on event, ({data})=>
      constructor.wrapArgs [data], (args)=> listener.call this, args...

  off:(event, listener)->
    getPusherEvent(event)
    @channel.off event, listener