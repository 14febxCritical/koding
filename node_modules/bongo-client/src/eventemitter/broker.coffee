module.exports = do->  
  getPusherEvent =(event)->
    if Array.isArray(event)
      event = event.join ':'
    else event

  {defineProperty} = Object

  afterInit:do ->
    channels = {}
    ->
      {broadcastable} = @constructor
      id = @getId?() or @bongo_?.instanceId
      if broadcastable and id?
        name = "object-#{id}"
        defineProperty @, "channel"
          value: channels[name] or= @mq.subscribe name
        @channel.on 'updateInstance', (data)=> 
          @update_(data)
  
  destroy:->
    return unless @channel?
    @mq.unsubscribe @channel
  
  on:(event, listener)->
    {constructor} = @
    event = getPusherEvent(event)
    multiplex = @multiplexer.on event, ->
      constructor.wrapArgs [].slice.call(arguments), (args)-> listener args...
    @channel.bind event, multiplex if multiplex

  off:(event, listener)->
    getPusherEvent(event)
    @channel.off event, listener