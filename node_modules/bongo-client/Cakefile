fs = require 'fs'
coffee = require 'coffee-script'
browserify = require 'browserify'
{spawn} = require 'child_process'

replacements = [
  [ '== typeof ', '=== typeof ' ]
  [ '!= typeof ', '!== typeof ' ]
]


task 'build', ->
  buildClient = spawn 'coffee', ['-cb', 'src/bongo.coffee']
  buildClient.stderr.on 'data', (data)->
    console.log data+''
  buildClient.on 'exit', ->
    process.nextTick ->
      fs.readFile 'src/bongo.js', (err, data)->
        throw err if err
        code = data.toString()

        for _, [replacement, was] of replacements
          code = code.replace was, replacement

        fs.writeFile 'src/bongo.js', code, ->
          throw err if err

          fs.rename 'src/bongo.js', 'bongo.js', (err)->
            throw err if err
            fs.writeFile 'browser/bongo.js', "!function(){\n#{browserify('bongo.js').bundle()}\n}();", (err)->
              throw err if err
              console.log 'build complete'
