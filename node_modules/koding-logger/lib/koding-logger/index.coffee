{EventEmitter} = require 'events'
amqp = require 'amqp'

tailLogs = require 'koding-log-tailer'

module.exports = class KodingLogger extends EventEmitter

  constructor:(@component, @hostname, @options, @noisy)->
    @routingPrefix = @hostname.split('.').reverse().join('.')
    @readyState = 0
    @pendingQueue = []
    @connection = amqp.createConnection(options)
    @connection.on 'ready', =>
      @connection.exchange 'logs',
        durable     : no
        autoDelete  : yes
      , (@exchange)=>
        @readyState = 1
        @logData.apply @, args for args in @pendingQueue
        @queue = []
        @emit 'ready'

  logData:(name, pid, severity, data)->
    console.log data if @noisy
    if @readyState is 0 
      @queue.push [name, severity, pid, data]
    else
      @exchange.publish "#{@routingPrefix}.#{@component}.#{pid}.#{name}.#{severity}", data

  logAll:(child, name)->
    child.stdout?.on 'data', @logData.bind(@, name, child.pid, 'stdout')
    child.stderr?.on 'data', @logData.bind(@, name, child.pid, 'stderr')
    child.on 'exit', @logData.bind(@, name, child.pid, 'exit')

  tailTo:(topic, stream)->
    [stream, topic] = [topic, stream] unless stream
    tailLogs
      topic       : topic ? "#{@routingPrefix}.#{@component}.#"
      connection  : @options
    , stream