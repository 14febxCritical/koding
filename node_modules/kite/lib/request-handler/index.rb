require "rubygems"
require "bundler/setup"
require 'pusher-client'
require 'net/http'

require './parse_options'

log = Logger.new($options[:logfile])

log.debug "LAUNCHING AN INSTANCE OF THE KITE REQUEST HANDLER"

class KiteRequestHandler
  def initialize(config)
    @config = config
    @socket = PusherClient::Socket.new(config[:key], config)
    krh_channel_name = "private-krh-#{$options[:kite_name]}"
    log.debug "ADDING join/part HANDLERS: #{krh_channel_name}"
    add_listener(krh_channel_name, 'join')
    add_listener(krh_channel_name, 'part')
  end
  
  def join(channel)
    log.debug "JOINING TO CHANNEL: #{channel.inspect}"
    add_listener(channel[:channel], 'client-message')
  end

  def part(channel)
    log.debug "PARTING FROM CHANNEL: #{channel.inspect}"
    @socket.unsubscribe(channel[:channel])
  end
   
  def add_listener(channel, event)
    @socket.subscribe(channel, 'khr')
    @socket[channel].bind(event) do |msg|
      clean_event = event
      clean_event[/^(client-)?/] = ''
      log.debug "RECEIVED AN EVENT: #{event} => #{clean_event}"
      if respond_to? clean_event
        log.debug "CLASS IMPLEMENTS A HANDLER: #{clean_event}"
        __send__(clean_event, msg) 
      else
        log.debug "CLASS CAN'T HANDLE EVENT; FORWARDING #{channel} #{event} #{msg}"
        send_request(channel, event,  msg)
      end
    end
  end

  def send_request(channel, event, msg)
    msg[:username] = channel.split('-')[2]
    res = Net::HTTP.post_form(URI.parse(@config[:kite_uri]), msg)
    puts res.body
  end

  def connect
    @socket.connect
  end
end

PusherClient.logger = log
handler = KiteRequestHandler.new($options)
handler.connect

