amqp = require 'amqp'

fetchConnection =(conn, callback)->
  if conn instanceof amqp.Connection
    if conn.readyState > 0
      callback options
    else
      conn.on 'ready', -> callback conn
  else
    connection = amqp.createConnection conn
    connection.on 'ready', -> callback connection

module.exports = (options, stream)->
  fetchConnection options.connection, (connection)->
    topic = options.topic ? options.hostname?.split('.').reverse().join('.')+'.#' ? '#'    
    connection.exchange 'logs',
      durable     : no
      autoDelete  : yes
    , (exchange)->
      connection.queue '', (queue)->
        queue.bind exchange, topic
        queue.on 'queueBindOk', ->
          queue.subscribe (message)->
            stream.write message.data