amqp = require 'amqp'

module.exports = (options, stream)->
  topic = options.topic ? hostname?.split('.').reverse().join('.')+'.#' ? '#'
  connection = amqp.createConnection(options.connection)
  connection.on 'ready', ->
    connection.exchange 'logs',
      durable     : no
      autoDelete  : yes
    , (exchange)->
      connection.queue '', (queue)->
        queue.bind exchange, topic
        queue.on 'queueBindOk', ->
          queue.subscribe (message)->
            stream.write message.data