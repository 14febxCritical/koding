<!DOCTYPE html>
<html>
<head>
<script src='//code.jquery.com/jquery-latest.js'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.6/prefixfree.min.js'></script>
<script src='/js/prefixfree.dynamic-dom.min.js'></script>
<style type="text/css" id="codeshare_style"></style>

<script type="text/javascript">

function sanitizeWindow() {

  // these methods need to be cleared
  window.confirm = function () {}
  window.prompt = function () {}
  window.open = function () {}
  window.print = function () {}
}

function handleDefaults() {
  if (!this.defaultValues) {
    this.defaultValues = {};

    for (var variable in window) {

      // keep default window values when resetting JS
      this.defaultValues[variable] = !0;
    }

    // overload setInterval and setTimeout to have a clearAll method
    window.setInterval = function (e) {
      var t = [],
      n = function (n, r) {
        return t[t.length] = e(n, r)
      };
      return n.clearAll = function () {
        var e;
        while (e = t.pop()) clearInterval(e)
      }, n
    }(window.setInterval)

    window.setTimeout = function (e) {
      var t = [],
      n = function (n, r) {
        return t[t.length] = e(n, r)
      };
      return n.clearAll = function () {
        var e;
        while (e = t.pop()) clearTimeout(e)
      }, n
    }(window.setTimeout)

  }
}

function resetFrame(){
        this.stopFrame();
        console.log("stopped");
        $("body").empty();
        $("head style#codeshare_style").empty();
}

function stopFrame(){
        for (var e in window) typeof this.defaultValues[e] == "undefined" && delete window[e];
        setTimeout.clearAll(), setInterval.clearAll()
        $("*").stop(true,true).clearQueue().unbind();
}

function receiveMessage(event)
{
    var codeshare, share_script;

    if (event.data != null) codeshare = JSON.parse(event.data);

    if (codeshare.resetFrame === true) this.resetFrame();

    else if (codeshare.stopFrame === true) this.stopFrame();

    else {
    // Prepare the CSS
      if (codeshare.cssPrefix === true) {
        codeshare.css = PrefixFree.prefixCSS(codeshare.css, true);
      }
    // Inject CSS
    $("head style#codeshare_style").html(codeshare.css, true);
    // Inject HTML
    $("body").html(codeshare.html);
    // Execute JS
    try {
            js = $.globalEval(codeshare.js), $(window).load()
        } catch (err) {
            typeof console != "undefined" && console.log(err.message)
            }
        }
    }



$(window).load(function(){

// Initialize
this.handleDefaults();
this.sanitizeWindow();

// Fetch the postMessage from the parent App
window.addEventListener("message", this.receiveMessage, false);

});
</script>
</head>
<body>
</body>
</html>
