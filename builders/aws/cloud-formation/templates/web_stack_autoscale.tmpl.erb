{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Deploy Koding web stack",
    "Parameters": {
        "KeyName": {
            "Default" : "koding",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access into the mon server",
            "Type": "String"
        },


        "WebServerInstanceType": {
            "Default": "m1.small",
            "Description": "The type of EC2 instance used for the WebServer server",
            "Type": "String",
            "AllowedValues": ["t1.micro","m1.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","m3.xlarge","m3.2xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"]
        },
      	"WebServerMinGroupSize" :{
         	"Default" : "1",
          	"Description" : "Minimum group size (0 <= minimum-size <= maximum-size). Required.", 
            "Type" : "String",
            "AllowedPattern": "[0-9]+" 
       	},
        "WebServerMaxGroupSize" : {
          	"Default" : "10",
           	"Description" : "Maximum group size (minimum-size <= maximum-size < 10000). Required.",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "WebServerDesiredCapacity": {
  	        "Default" : 1,
           	"Description" : "Specifies the desired capacity for the auto scaling group",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"

        },
        "WebServerCpuAlarmHight":{
            "Default" : "60",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "WebServerCpuAlarmLow":{
            "Default" : "30",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },



        "SocialWorkerInstanceType": {
            "Default": "m1.small",
            "Description": "The type of EC2 instance used for the SocialWorker server",
            "Type": "String",
            "AllowedValues": ["t1.micro","m1.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","m3.xlarge","m3.2xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"]
        },
      	"SocialWorkerMinGroupSize" :{
         	"Default" : "1",
          	"Description" : "Minimum group size (0 <= minimum-size <= maximum-size). Required.", 
            "Type" : "String",
            "AllowedPattern": "[0-9]+" 
       	},
        "SocialWorkerMaxGroupSize" : {
          	"Default" : "10",
           	"Description" : "Maximum group size (minimum-size <= maximum-size < 10000). Required.",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "SocialWorkerDesiredCapacity": {
  	        "Default" : 1,
           	"Description" : "Specifies the desired capacity for the auto scaling group",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"

        },
        "SocialWorkerCpuAlarmHight":{
            "Default" : "60",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "SocialWorkerCpuAlarmLow":{
            "Default" : "30",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },


        "GuestCleanupInstanceType": {
            "Default": "m1.small",
            "Description": "The type of EC2 instance used for the GuestCleanup server",
            "Type": "String",
            "AllowedValues": ["t1.micro","m1.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","m3.xlarge","m3.2xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"]
        },
      	"GuestCleanupMinGroupSize" :{
         	"Default" : "1",
          	"Description" : "Minimum group size (0 <= minimum-size <= maximum-size). Required.", 
            "Type" : "String",
            "AllowedPattern": "[0-9]+" 
       	},
        "GuestCleanupMaxGroupSize" : {
          	"Default" : "10",
           	"Description" : "Maximum group size (minimum-size <= maximum-size < 10000). Required.",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "GuestCleanupDesiredCapacity": {
  	        "Default" : 1,
           	"Description" : "Specifies the desired capacity for the auto scaling group",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"

        },
        "GuestCleanupCpuAlarmHight":{
            "Default" : "60",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "GuestCleanupCpuAlarmLow":{
            "Default" : "30",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },




        "AuthWorkerInstanceType": {
            "Default": "m1.small",
            "Description": "The type of EC2 instance used for the AuthWorker server",
            "Type": "String",
            "AllowedValues": ["t1.micro","m1.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m2.4xlarge","m3.xlarge","m3.2xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"]
        },
      	"AuthWorkerMinGroupSize" :{
         	"Default" : "1",
          	"Description" : "Minimum group size (0 <= minimum-size <= maximum-size). Required.", 
            "Type" : "String",
            "AllowedPattern": "[0-9]+" 
       	},
        "AuthWorkerMaxGroupSize" : {
          	"Default" : "10",
           	"Description" : "Maximum group size (minimum-size <= maximum-size < 10000). Required.",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "AuthWorkerDesiredCapacity": {
  	        "Default" : 1,
           	"Description" : "Specifies the desired capacity for the auto scaling group",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"

        },
        "AuthWorkerCpuAlarmHight":{
            "Default" : "60",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        },
        "AuthWorkerCpuAlarmLow":{
            "Default" : "30",
            "Description":"Alarm if CPU too high or metric disappears indicating instance is down",
            "Type" : "String",
            "AllowedPattern": "[0-9]+"
        }






    },
    "Resources" :{


      	 "WebServerLaunchConfiguration" : {
      		"Type" : "AWS::AutoScaling::LaunchConfiguration",  
      		"Properties" : {
        		"InstanceType" : {"Ref":"WebServerInstanceType"},
          		"SecurityGroups" : ["sg-b17399de"],
            	"KeyName" : {"Ref": "KeyName"},
                "ImageId" : "ami-3d4ff254",
                "UserData":{"Fn::Base64": <%= web_server_bootstrap_script.to_json %>}
             } 
          },
      	 "SocialWorkerLaunchConfiguration" : {
      		"Type" : "AWS::AutoScaling::LaunchConfiguration",  
      		"Properties" : {
        		"InstanceType" : {"Ref":"SocialWorkerInstanceType"},
          		"SecurityGroups" : ["sg-b17399de"],
            	"KeyName" : {"Ref": "KeyName"},
                "ImageId" : "ami-3d4ff254",
                "UserData":{"Fn::Base64": <%= socialworker_bootstrap_script.to_json %>}
             } 
          },
      	 "GuestCleanupLaunchConfiguration" : {
      		"Type" : "AWS::AutoScaling::LaunchConfiguration",  
      		"Properties" : {
        		"InstanceType" : {"Ref":"GuestCleanupInstanceType"},
          		"SecurityGroups" : ["sg-b17399de"],
            	"KeyName" : {"Ref": "KeyName"},
                "ImageId" : "ami-3d4ff254",
                "UserData":{"Fn::Base64": <%= guestcleanup_bootstrap_script.to_json %>}
             } 
          },
      	 "AuthWorkerLaunchConfiguration" : {
      		"Type" : "AWS::AutoScaling::LaunchConfiguration",  
      		"Properties" : {
        		"InstanceType" : {"Ref":"AuthWorkerInstanceType"},
          		"SecurityGroups" : ["sg-b17399de"],
            	"KeyName" : {"Ref": "KeyName"},
                "ImageId" : "ami-3d4ff254",
                "UserData":{"Fn::Base64": <%= authworker_bootstrap_script.to_json %>}
             } 
          },






          "WebServerScalingGroup" : {
              "Type" :"AWS::AutoScaling::AutoScalingGroup",
              "Properties" : {
                	 "VPCZoneIdentifier" : ["subnet-c5fe04a8","subnet-71fe041c","subnet-dcd019b6","subnet-1ef90373"],
                  	  "AvailabilityZones" : ["us-east-1a", "us-east-1b", "us-east-1c", "us-east-1d"],
                      "LaunchConfigurationName" : {"Ref": "WebServerLaunchConfiguration" },
                      "MinSize": {"Ref":"WebServerMinGroupSize"},
                      "MaxSize": {"Ref":"WebServerMaxGroupSize"},
                      "DesiredCapacity": {"Ref":"WebServerDesiredCapacity"},
                      "LoadBalancerNames": ["webstack-WebSiteE-1DV1IQWAGCTJC"]
                     } 
          },  
          "SocialWorkerScalingGroup" : {
              "Type" :"AWS::AutoScaling::AutoScalingGroup",
              "Properties" : {
                	 "VPCZoneIdentifier" : ["subnet-c5fe04a8","subnet-71fe041c","subnet-dcd019b6","subnet-1ef90373"],
                  	  "AvailabilityZones" : ["us-east-1a", "us-east-1b", "us-east-1c", "us-east-1d"],
                      "LaunchConfigurationName" : {"Ref": "SocialWorkerLaunchConfiguration" },
                      "MinSize": {"Ref":"SocialWorkerMinGroupSize"},
                      "MaxSize": {"Ref":"SocialWorkerMaxGroupSize"},
                      "DesiredCapacity": {"Ref":"SocialWorkerDesiredCapacity"}
                     } 
          },  
          "GuestCleanupScalingGroup" : {
              "Type" :"AWS::AutoScaling::AutoScalingGroup",
              "Properties" : {
                	 "VPCZoneIdentifier" : ["subnet-c5fe04a8","subnet-71fe041c","subnet-dcd019b6","subnet-1ef90373"],
                  	  "AvailabilityZones" : ["us-east-1a", "us-east-1b", "us-east-1c", "us-east-1d"],
                      "LaunchConfigurationName" : {"Ref": "GuestCleanupLaunchConfiguration" },
                      "MinSize": {"Ref":"GuestCleanupMinGroupSize"},
                      "MaxSize": {"Ref":"GuestCleanupMaxGroupSize"},
                      "DesiredCapacity": {"Ref":"GuestCleanupDesiredCapacity"}
                     } 
          },  
          "AuthWorkerScalingGroup" : {
              "Type" :"AWS::AutoScaling::AutoScalingGroup",
              "Properties" : {
                	 "VPCZoneIdentifier" : ["subnet-c5fe04a8","subnet-71fe041c","subnet-dcd019b6","subnet-1ef90373"],
                  	  "AvailabilityZones" : ["us-east-1a", "us-east-1b", "us-east-1c", "us-east-1d"],
                      "LaunchConfigurationName" : {"Ref": "AuthWorkerLaunchConfiguration" },
                      "MinSize": {"Ref":"AuthWorkerMinGroupSize"},
                      "MaxSize": {"Ref":"AuthWorkerMaxGroupSize"},
                      "DesiredCapacity": {"Ref":"AuthWorkerDesiredCapacity"}
                     } 
          },  






          "WebServerCPUAlarmHigh" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"WebServerCpuAlarmHight"},
                    "AlarmDescription": "Alarm if CPU too high or metric disappears indicating instance is down",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "WebServerAutoScalingUPPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "GreaterThanThreshold",
                    "MetricName": "WebServerHightCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"WebServerScalingGroup",
                        "Value": {"Ref":"WebServerScalingGroup"}
                      }
                    ]
              }
               
          },
          "WebServerCPUAlarmLow" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"WebServerCpuAlarmLow"},
                    "AlarmDescription": "Alarm if CPU too low",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "WebServerAutoScalingDownPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "LessThanThreshold",
                    "MetricName": "WebServerLowCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"WebServerScalingGroup",
                        "Value": {"Ref":"WebServerScalingGroup"}
                      }
                    ]
              }
               
          },





          "SocialWorkerCPUAlarmHigh" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"SocialWorkerCpuAlarmHight"},
                    "AlarmDescription": "Alarm if CPU too high or metric disappears indicating instance is down",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "SocialWorkerAutoScalingUPPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "GreaterThanThreshold",
                    "MetricName": "SocialWorkerHightCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"SocialWorkerScalingGroup",
                        "Value": {"Ref":"SocialWorkerScalingGroup"}
                      }
                    ]
              }
               
          },
          "SocialWorkerCPUAlarmLow" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"SocialWorkerCpuAlarmLow"},
                    "AlarmDescription": "Alarm if CPU too low",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "SocialWorkerAutoScalingDownPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "LessThanThreshold",
                    "MetricName": "SocialWorkerLowCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"SocialWorkerScalingGroup",
                        "Value": {"Ref":"SocialWorkerScalingGroup"}
                      }
                    ]
              }
               
          },

          "GuestCleanupCPUAlarmHigh" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"GuestCleanupCpuAlarmHight"},
                    "AlarmDescription": "Alarm if CPU too high or metric disappears indicating instance is down",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "GuestCleanupAutoScalingUPPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "GreaterThanThreshold",
                    "MetricName": "GuestCleanupHightCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"GuestCleanupScalingGroup",
                        "Value": {"Ref":"GuestCleanupScalingGroup"}
                      }
                    ]
              }
               
          },
          "GuestCleanupCPUAlarmLow" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"GuestCleanupCpuAlarmLow"},
                    "AlarmDescription": "Alarm if CPU too low",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "GuestCleanupAutoScalingDownPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "LessThanThreshold",
                    "MetricName": "GuestCleanupLowCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"GuestCleanupScalingGroup",
                        "Value": {"Ref":"GuestCleanupScalingGroup"}
                      }
                    ]
              }
               
          },


          "AuthWorkerCPUAlarmHigh" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"AuthWorkerCpuAlarmHight"},
                    "AlarmDescription": "Alarm if CPU too high or metric disappears indicating instance is down",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "AuthWorkerAutoScalingUPPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "GreaterThanThreshold",
                    "MetricName": "AuthWorkerHightCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"AuthWorkerScalingGroup",
                        "Value": {"Ref":"AuthWorkerScalingGroup"}
                      }
                    ]
              }
               
          },
          "AuthWorkerCPUAlarmLow" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": {"Ref":"AuthWorkerCpuAlarmLow"},
                    "AlarmDescription": "Alarm if CPU too low",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "AuthWorkerAutoScalingDownPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "LessThanThreshold",
                    "MetricName": "AuthWorkerLowCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"AuthWorkerScalingGroup",
                        "Value": {"Ref":"AuthWorkerScalingGroup"}
                      }
                    ]
              }
               
          },



          "WebServerAutoScalingUPPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "WebServerScalingGroup"},   
        			"ScalingAdjustment" : "1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },
          "WebServerAutoScalingDownPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "WebServerScalingGroup"},   
        			"ScalingAdjustment" : "-1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },

          "SocialWorkerAutoScalingUPPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "SocialWorkerScalingGroup"},   
        			"ScalingAdjustment" : "1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },
          "SocialWorkerAutoScalingDownPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "SocialWorkerScalingGroup"},   
        			"ScalingAdjustment" : "-1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },

          "GuestCleanupAutoScalingUPPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "GuestCleanupScalingGroup"},   
        			"ScalingAdjustment" : "1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },
          "GuestCleanupAutoScalingDownPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "GuestCleanupScalingGroup"},   
        			"ScalingAdjustment" : "-1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },

          "AuthWorkerAutoScalingUPPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "AuthWorkerScalingGroup"},   
        			"ScalingAdjustment" : "1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },
          "AuthWorkerAutoScalingDownPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "AuthWorkerScalingGroup"},   
        			"ScalingAdjustment" : "-1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  }



    }
}
