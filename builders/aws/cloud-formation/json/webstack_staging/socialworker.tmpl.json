{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Deploy SocialWorker",
    "Resources" :{

      	 "SocialWorkerLaunchConfiguration" : {
      		"Type" : "AWS::AutoScaling::LaunchConfiguration",  
      		"Properties" : {
        		"InstanceType" : "m1.small",
          		"SecurityGroups" : ["sg-b17399de"],
            	"KeyName" : "koding",
                "ImageId" : "ami-3d4ff254",
                "UserData":{"Fn::Base64": "#cloud-config\n\n\nresize_rootfs: true\n\napt_update: true\napt_upgrade: true\ntimezone: US/Pacific\n\n\napt_sources:\n - source: \"deb http://apt.opscode.com/ $RELEASE-0.10 main\"\n   key: |\n     -----BEGIN PGP PUBLIC KEY BLOCK-----\n     Version: GnuPG v1.4.9 (GNU/Linux)\n     \n     mQGiBEppC7QRBADfsOkZU6KZK+YmKw4wev5mjKJEkVGlus+NxW8wItX5sGa6kdUu\n     twAyj7Yr92rF+ICFEP3gGU6+lGo0Nve7KxkN/1W7/m3G4zuk+ccIKmjp8KS3qn99\n     dxy64vcji9jIllVa+XXOGIp0G8GEaj7mbkixL/bMeGfdMlv8Gf2XPpp9vwCgn/GC\n     JKacfnw7MpLKUHOYSlb//JsEAJqao3ViNfav83jJKEkD8cf59Y8xKia5OpZqTK5W\n     ShVnNWS3U5IVQk10ZDH97Qn/YrK387H4CyhLE9mxPXs/ul18ioiaars/q2MEKU2I\n     XKfV21eMLO9LYd6Ny/Kqj8o5WQK2J6+NAhSwvthZcIEphcFignIuobP+B5wNFQpe\n     DbKfA/0WvN2OwFeWRcmmd3Hz7nHTpcnSF+4QX6yHRF/5BgxkG6IqBIACQbzPn6Hm\n     sMtm/SVf11izmDqSsQptCrOZILfLX/mE+YOl+CwWSHhl+YsFts1WOuh1EhQD26aO\n     Z84HuHV5HFRWjDLw9LriltBVQcXbpfSrRP5bdr7Wh8vhqJTPjrQnT3BzY29kZSBQ\n     YWNrYWdlcyA8cGFja2FnZXNAb3BzY29kZS5jb20+iGAEExECACAFAkppC7QCGwMG\n     CwkIBwMCBBUCCAMEFgIDAQIeAQIXgAAKCRApQKupg++Caj8sAKCOXmdG36gWji/K\n     +o+XtBfvdMnFYQCfTCEWxRy2BnzLoBBFCjDSK6sJqCu5Ag0ESmkLtBAIAIO2SwlR\n     lU5i6gTOp42RHWW7/pmW78CwUqJnYqnXROrt3h9F9xrsGkH0Fh1FRtsnncgzIhvh\n     DLQnRHnkXm0ws0jV0PF74ttoUT6BLAUsFi2SPP1zYNJ9H9fhhK/pjijtAcQwdgxu\n     wwNJ5xCEscBZCjhSRXm0d30bK1o49Cow8ZIbHtnXVP41c9QWOzX/LaGZsKQZnaMx\n     EzDk8dyyctR2f03vRSVyTFGgdpUcpbr9eTFVgikCa6ODEBv+0BnCH6yGTXwBid9g\n     w0o1e/2DviKUWCC+AlAUOubLmOIGFBuI4UR+rux9affbHcLIOTiKQXv79lW3P7W8\n     AAfniSQKfPWXrrcAAwUH/2XBqD4Uxhbs25HDUUiM/m6Gnlj6EsStg8n0nMggLhuN\n     QmPfoNByMPUqvA7sULyfr6xCYzbzRNxABHSpf85FzGQ29RF4xsA4vOOU8RDIYQ9X\n     Q8NqqR6pydprRFqWe47hsAN7BoYuhWqTtOLSBmnAnzTR5pURoqcquWYiiEavZixJ\n     3ZRAq/HMGioJEtMFrvsZjGXuzef7f0ytfR1zYeLVWnL9Bd32CueBlI7dhYwkFe+V\n     Ep5jWOCj02C1wHcwt+uIRDJV6TdtbIiBYAdOMPk15+VBdweBXwMuYXr76+A7VeDL\n     zIhi7tKFo6WiwjKZq0dzctsJJjtIfr4K4vbiD9Ojg1iISQQYEQIACQUCSmkLtAIb\n     DAAKCRApQKupg++CauISAJ9CxYPOKhOxalBnVTLeNUkAHGg2gACeIsbobtaD4ZHG\n     0GLl8EkfA8uhluM=\n     =zKAm\n     -----END PGP PUBLIC KEY BLOCK-----\n\nchef:\n    install_type: \"packages\"\n    server_url: \"https://api.opscode.com/organizations/koding\"\n    \n    # Defaults to the instance-id if not present\n    # node_name: \"your-node-name\"\n    environment: \"staging\"\n\n    validation_name: \"koding-validator\"\n\n    validation_key: |\n        -----BEGIN RSA PRIVATE KEY-----\n        MIIEowIBAAKCAQEAtqDCkXW6qnlEkn4cr67s7GRK8uyL/h78I/KpBzAwA09rKyMN\n        JjkSh5JctMPmpTlKPsQsLNz4dF60V5X5UmOMs/S8QtWRv/L9aXR9WEYmCx+41mwJ\n        +TC+Fa3Qes+lqrvEIluqf1scdJQ+lV9HDXDjhx/TxYlSqtVZsaZwtXIYYFik0G6M\n        czBi3TOOTSRdrOghvyAyS5EM+bryFbm0ZRkiFg6/2A4gY6hOcAzxqv1DwIMx86uP\n        zSPb4uuqr5cSOpv2c/Uj1WSWWJsJQCko/5grxN28o/WB6KvboE7FDcGsrWjQJNj+\n        Zj4j5FIKL71gYd7eB1smQ3JNoorlInIN+oaavwIDAQABAoIBADdl/J9zPvSHZK2r\n        Y7hHL8dlhPa7mpuzenjNG0j67RWT+cZUE6EMnvpRA54x7r0f682uZFgXj6Z9M+d9\n        ruu3Fu9fxdvgPR4k74oVtBAa919YeBFTJJNanc6lsyAN7QslehGSDN4lHTSf43wc\n        Msl4/Qv4M50wUstPfK3O91GTEqHmvoQp7ZQ3XMQznvaM7YL2Zsf5KO0WTEJjXljB\n        88HoQ841yn65C/6EnKQyICzwdnBCsSQyVx/wmSG2kSWkeeaULgruaQUW7WC4tHtV\n        5zMsLEaa7+YAeDuiC/25Sq4B0a8LaoQ97JKZkH9TSR6hQptge7UTXzGYgh6LLa/2\n        lguzR4ECgYEA4rYdRTedWSwpR/4j/mE7HkqBgsUPLWJxV8pSnT49KeCtvfadDkFJ\n        9lmXUd5AmQFHdxmqSIhBogmMPmE1xJ+OT1MTkDSxhLmM/Fdx89FQScHGhfXQ2Z7X\n        Q4iaramo60LEZHkuALL+o3wmsumO3x72Xk2VfVgQcE3n8ejdSnaJPwcCgYEAzjiz\n        vbo5FyQbO1xX/QSK/rzWGQndisxYvKZCxRmEo8DYSxGBam0m4THGb+iLLL8doWug\n        tSj4J7ArXLI8OPZ0gigI+1JoCjViC9OrU/gnIVUabSosGO/4I+QgW7N3OiSGN1d/\n        GEWpKIVgstUj4M1tgdFFqAgGcI5CKV87D4N1IIkCgYEAgtLITTrsh5qeL7cNmisN\n        bEteNNH2EiBue1R7G9XggZvvZmE6/BDc11WXplx0NlawoJ+kzboi9ZhA33ZFCrNv\n        8YJlFZ/ymD5ihvMHBMVSaV1ya7cPz6SDX6siZvgyS5/5qGjtDOY9XqWzxyZTlZlO\n        XdizXONGiSfLoqLXn7KLPF0CgYA9GsoPjs150OYMycj8nMr+vj+GPckaZoBora8d\n        LfmCeBLe83nwahVaJuCQqkwK3zpNaVG+PDyDrgy7M8jqbASLyIcYyQsw8y5xKLAc\n        emxF0Sy6agOVBA33vJHl+iB65vWqElADhiigbB0CAGvYIaawD61fI7mcwlpSXfhn\n        GWGsWQKBgBuClx9H0TVZT35mSx5EYJjuvIF0hlo/7HqlZXHSDLpobHG14uLSrZy5\n        Gq9OJ6HmYF4y9Eeh5kNqcwvPBV3nzy14mKPrMadaVwjtLQtfYzicnau+9sqnPEx7\n        IFV2d9n9RwYIEWQmSl4C1ndm70kmKm0igXJFfLGNA/beEON8od/y\n        -----END RSA PRIVATE KEY-----\n    \n    # A run list for a first boot json\n    run_list:\n      - \"role[socialworker]\"\n\nruncmd:\n  - [/etc/init.d/chef-client, restart ]\n\noutput: {all: '| tee -a /var/log/cloud-init-output.log'}\n"}
             } 
          },


          "SocialWorkerScalingGroup" : {
              "Type" :"AWS::AutoScaling::AutoScalingGroup",
              "Properties" : {
                	 "VPCZoneIdentifier" : ["subnet-c5fe04a8","subnet-71fe041c","subnet-dcd019b6","subnet-1ef90373"],
                  	  "AvailabilityZones" : ["us-east-1a", "us-east-1b", "us-east-1c", "us-east-1d"],
                      "LaunchConfigurationName" : {"Ref": "SocialWorkerLaunchConfiguration" },
                      "MinSize": "1",
                      "MaxSize": "10",
                      "DesiredCapacity": "1"
              } 
          },  


          "SocialWorkerCPUAlarmHigh" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": "60",
                    "AlarmDescription": "Alarm if CPU too high or metric disappears indicating instance is down",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "SocialWorkerAutoScalingUPPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "GreaterThanThreshold",
                    "MetricName": "SocialWorkerHightCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"SocialWorkerScalingGroup",
                        "Value": {"Ref":"SocialWorkerScalingGroup"}
                      }
                    ]
              }
               
          },
          "SocialWorkerCPUAlarmLow" : {
              "Type" : "AWS::CloudWatch::Alarm",
              "Properties": {
                    "EvaluationPeriods" : "1",
                    "Statistic": "Average",
                    "Threshold": "30",
                    "AlarmDescription": "Alarm if CPU too low",
                    "Period":"60",
                    "AlarmActions": [
                        {"Ref": "SocialWorkerAutoScalingDownPolicy"}
                    ],
                    "Namespace":"AWS/EC2",
                    "ComparisonOperator": "LessThanThreshold",
                    "MetricName": "SocialWorkerLowCPUUtilization",
                    "Dimensions" : [
                      {
                        "Name":"SocialWorkerScalingGroup",
                        "Value": {"Ref":"SocialWorkerScalingGroup"}
                      }
                    ]
              }
               
          },


          "SocialWorkerAutoScalingUPPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "SocialWorkerScalingGroup"},   
        			"ScalingAdjustment" : "1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  },
          "SocialWorkerAutoScalingDownPolicy" : {
			 "Type" : "AWS::AutoScaling::ScalingPolicy",  
      		 "Properties" : {
        			"AutoScalingGroupName" : {"Ref" : "SocialWorkerScalingGroup"},   
        			"ScalingAdjustment" : "-1",  
        			"AdjustmentType" : "ChangeInCapacity" 
      		 }
    	  }
    }
}
